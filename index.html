<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="icon" href="./favicon.ico">

    <title>Ontario COVID Data</title>

    <!-- Bootstrap core CSS -->
    <link href="bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="jingle.css" rel="stylesheet">
</head>

<body>

    <main role="main">

        <!-- Main jumbotron for a primary marketing message or call to action -->
        <div class="jumbotron">
            <div class="wrapper">
                <h1 id="title">Ontario COVID Statistics for </h1><br>
            </div>
        </div>
        <div class="wrapper">
            <div class="contained">
                <h2>Yesterday's Numbers</h2><br>
                <span class="stat cases-inc"></span> new cases<br>
                <span class="stat" id="tests"></span> tests given<br>
                <span class="stat" id="percent"></span> positivity rate<br>
                <span class="stat" id="daily-doses"></span> vaccine doses given (<span class="stat" id="daily-partial"></span> inital, <span class="stat" id="daily-final"></span> final)
            </div>
            <br>
            <div class="grid-container">
                <div class="contained">
                    <h2>Cases</h2><br>
                    Positive Cases (<span class="delta" id="positive-inc"></span>):<p class="stat" id="positive"></p>
                    Resolved Cases (<span class="delta" id="resolved-inc"></span>):<p class="stat" id="resolved"></p>
                    Total Deaths (<span class="delta" id="deaths-inc"></span>):<p class="stat" id="deaths"></p>
                    Total Cases (<span class="delta cases-inc"></span>):<p class="stat" id="cases"></p>
                </div>
                <div class="contained">
                    <h2>Vaccines</h2><br>
                    Total Doses Given: <p class="stat" id="total-doses"></p>
                    Fully Vaccinated: <p class="stat" id="total-vaccinated"></p>
                    Partially Vaccinated: <p class="stat" id="partially-vaccinated"></p>
                </div>
                <div class="contained">
                    <h2>Hospitalized</h2><br>
                    Eligible for a Test:<p class="stat" id="testable"></p>
                    In Hospital:<p class="stat" id="hospital"></p>
                    In ICU:<p class="stat" id="icu"></p>
                    On Ventilator<p class="stat" id="ventilator"></p>
                </div>
                <div class="contained">
                    <h2>LTCs</h2><br>
                    Total LTC Resident Cases:<p class="stat" id="ltcCases"></p>
                    Total LTC Worker Cases:<p class="stat" id="ltcHcwCases"></p>
                    Total LTC Resident Deaths:<p class="stat" id="ltcDeaths"></p>
                    Total LTC Worker Deaths:<p class="stat" id="ltcHcwDeaths"></p>
                </div>
            </div>
        </div> <!-- /container -->
    </main>

    <footer class="wrapper">
        <hr>
        <small>Updates every 15 minutes - created by Brian Chahley in 2021</small>
    </footer>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script>window.jQuery || document.write('<script src="jquery-3.5.1.min.js"><\/script>')</script>
    <script src="papaparse.min.js"></script>
    <script src="bootstrap.min.js"></script>
    <script>$(document).ready(() => {

        // Add comma separators to numeric string, or return the string if it cant be parsed (already has commas)
        function fmt(string) {
            let x = Number(string);
            if (!isNaN(x))  {
            return x.toLocaleString() }
            else { return string }
        }

            $.ajax({
                type: "GET",
                url: "./covidtesting.csv",
                success: function (data) {
                    var results = Papa.parse(data, {
                        header: true,
                        worker: true,
                        complete: function (results) {
                            // console.log("Case data:" + JSON.stringify(results));
                            let todaysData = results.data[results.data.length - 2];
                            let yesterdaysData = results.data[results.data.length - 3];
                            $("#title").append(todaysData["Reported Date"]);
                            $("#positive").text(fmt(todaysData["Confirmed Positive"]));
                            $("#positive-inc").text(Number((todaysData["Confirmed Positive"]) - Number(yesterdaysData["Confirmed Positive"])).toLocaleString());
                            $("#resolved").text(fmt(todaysData["Resolved"]));
                            $("#resolved-inc").text(Number((todaysData["Resolved"]) - Number(yesterdaysData["Resolved"])).toLocaleString());
                            $("#deaths").text(fmt(todaysData["Deaths"]));
                            $("#deaths-inc").text(Number((todaysData["Deaths"]) - Number(yesterdaysData["Deaths"])).toLocaleString());
                            $("#cases").text(fmt(todaysData["Total Cases"]));
                            $(".cases-inc").text((Number(todaysData["Total Cases"]) - Number(yesterdaysData["Total Cases"])).toLocaleString());
                            $("#testable").text(fmt(todaysData["Total patients approved for testing as of Reporting Date"]));
                            $("#tests").text(fmt(todaysData["Total tests completed in the last day"]));
                            $("#percent").text(fmt(todaysData["Percent positive tests in last day"]) + "%");
                            $("#hospital").text(fmt(todaysData["Number of patients hospitalized with COVID-19"]));
                            $("#icu").text(fmt(todaysData["Number of patients in ICU with COVID-19"]));
                            $("#ventilator").text(fmt(todaysData["Number of patients in ICU on a ventilator with COVID-19"]));
                            $("#ltcCases").text(fmt(todaysData["Total Positive LTC Resident Cases"]));
                            $("#ltcHcwCases").text(fmt(todaysData["Total Positive LTC HCW Cases"]));
                            $("#ltcDeaths").text(fmt(todaysData["Total LTC Resident Deaths"]));
                            $("#ltcHcwDeaths").text(fmt(todaysData["Total LTC HCW Deaths"]));
                            $(".delta").each(function () {
                                $(this).addClass(function () { let x = Number(this.innerText) > 0 ? "positive" : "negative"; return x });
                                if ($(this).hasClass("positive")) { $(this).prepend("+") }
                            });
                        }
                    });
                }
            });

            $.ajax({
                type: "GET",
                url: "./vaccine_doses.csv",
                success: function (data) {
                    var results = Papa.parse(data, {
                        header: true,
                        worker: true,
                        complete: function (results) {
                            // console.log("Vaccine data:" + JSON.stringify(results));
                            let todaysData = results.data[results.data.length - 2];
                            let yesterdaysData = results.data[results.data.length - 3];

                            let terms = ["previous_day_doses_administered", "total_doses_administered", "total_individuals_fully_vaccinated"];
                            terms.forEach((term)=>{
                                todaysData[term] = todaysData[term].replace(",","");
                                yesterdaysData[term] = yesterdaysData[term].replace(",","");
                            });

                            $("#daily-doses").text(fmt(todaysData["previous_day_doses_administered"]));
                            $("#total-doses").text(fmt(todaysData["total_doses_administered"]));
                            $("#total-vaccinated").text(fmt(todaysData["total_individuals_fully_vaccinated"]));
                            let partial_total = (Number(todaysData["total_doses_administered"]) - Number(todaysData["total_individuals_fully_vaccinated"]));
                            $("#partially-vaccinated").text(partial_total.toLocaleString());
                            let daily_final = (Number(todaysData["total_individuals_fully_vaccinated"]) - Number(yesterdaysData["total_individuals_fully_vaccinated"]));
                            $("#daily-final").text(daily_final.toLocaleString());
                            let daily_partial = (Number(todaysData["previous_day_doses_administered"]) - Number(daily_final));
                            $("#daily-partial").text(daily_partial.toLocaleString());


                        }
                    });
                }
            });

        })</script>
</body>

</html>