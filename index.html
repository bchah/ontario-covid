<!doctype html>
<html lang="en">

<head>
    <title>Ontario COVID Data</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.7, shrink-to-fit=no">
    <link rel="icon" href="./favicon.ico">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="covid.css" rel="stylesheet">
</head>

<body>

    <main role="main">
        <div class="jumbotron">
            <div class="wrapper">
               <h1 id="title"><object data="virus.svg" class="logo" type="image/svg+xml"></object> Ontario COVID Data for </h1><br>
            </div>
        </div>
        <div class="wrapper">
            <div class="contained">
                <h2>Today's Numbers</h2><br>
                <span class="stat deaths-inc"></span> deaths<br>
                <span class="stat cases-inc"></span> new cases<br>
                <span class="stat resolved-inc"></span> resolved cases<br>
                <span class="stat" id="tests"></span> tests given<br>
                <span class="stat" id="percent"></span> positivity rate<br>
                <span class="stat" id="daily-doses"></span> vaccine doses given (<span class="stat"
                    id="daily-partial"></span> inital, <span class="stat" id="daily-final"></span> final)
            </div>
            <br>
            <div class="grid-container">
                <div class="contained">
                    <h2>Cases</h2><br>
                    Total Positive (<span class="delta positive-inc"></span>):<p class="stat" id="positive"></p>
                    Total Resolved (<span class="delta resolved-inc"></span>):<p class="stat" id="resolved"></p>
                    Total Deaths (<span class="delta deaths-inc"></span>):<p class="stat" id="deaths"></p>
                    Total Cases (<span class="delta cases-inc"></span>):<p class="stat" id="cases"></p>
                </div>
                <div class="contained">
                    <h2>Vaccines</h2><br>
                    Total Doses Given: <p class="stat" id="total-doses"></p>
                    Fully Vaccinated: <p class="stat" id="total-vaccinated"></p>
                    Partially Vaccinated: <p class="stat" id="partially-vaccinated"></p>
                </div>
                <div class="contained">
                    <h2>Hospitalized</h2><br>
                    Eligible for a Test:<p class="stat" id="testable"></p>
                    In Hospital:<p class="stat" id="hospital"></p>
                    In ICU:<p class="stat" id="icu"></p>
                    On Ventilator<p class="stat" id="ventilator"></p>
                </div>
                <div class="contained">
                    <h2>LTCs</h2><br>
                    Total LTC Resident Cases:<p class="stat" id="ltcCases"></p>
                    Total LTC Worker Cases:<p class="stat" id="ltcHcwCases"></p>
                    Total LTC Resident Deaths:<p class="stat" id="ltcDeaths"></p>
                    Total LTC Worker Deaths:<p class="stat" id="ltcHcwDeaths"></p>
                </div>
            </div>
        </div>
    </main>

    <footer class="wrapper">
        <hr>
        <small>Viewing the latest available information from <a href="https://data.ontario.ca">data.ontario.ca</a>
            <br>&copy; 2021 Brian Chahley</small>
    </footer>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>$(document).ready(() => {

            // Add comma separators to numeric string, or return the string itself if it cant be parsed (already has commas)
            function fmt(string) {
                let x = Number(string);
                if (!isNaN(x)) {
                    return x.toLocaleString()
                }
                else { return string }
            }


            // Case data
            $.ajax({
                type: 'POST',
                url: 'https://data.ontario.ca/en/api/3/action/datastore_search',
                cache: true,
                data: {
                    resource_id: 'ed270bb8-340b-41f9-a7c6-e8ef587e6d11',
                    limit: 32000
                },
                dataType: "jsonp",
                success: function (data) {

                    let length = data.result.records.length;
                    let todaysData = data.result.records[length - 1];
                    let yesterdaysData = data.result.records[length - 2];

                    $("#title").append(todaysData["Reported Date"].replace(/(\d{4}-\d{2}-\d{2}).*/, "$1"));
                    $("#positive").text(fmt(todaysData["Confirmed Positive"]));
                    $(".positive-inc").text(Number((todaysData["Confirmed Positive"]) - Number(yesterdaysData["Confirmed Positive"])).toLocaleString());
                    $("#resolved").text(fmt(todaysData["Resolved"]));
                    $(".resolved-inc").text(Number((todaysData["Resolved"]) - Number(yesterdaysData["Resolved"])).toLocaleString());
                    $("#deaths").text(fmt(todaysData["Deaths"]));
                    $(".deaths-inc").text(Number((todaysData["Deaths"]) - Number(yesterdaysData["Deaths"])).toLocaleString());
                    $("#cases").text(fmt(todaysData["Total Cases"]));
                    $(".cases-inc").text((Number(todaysData["Total Cases"]) - Number(yesterdaysData["Total Cases"])).toLocaleString());
                    $("#testable").text(fmt(todaysData["Total patients approved for testing as of Reporting Date"]));
                    $("#tests").text(fmt(todaysData["Total tests completed in the last day"]));
                    $("#percent").text(fmt(todaysData["Percent positive tests in last day"]) + "%");
                    $("#hospital").text(fmt(todaysData["Number of patients hospitalized with COVID-19"]));
                    $("#icu").text(fmt(todaysData["Number of patients in ICU with COVID-19"]));
                    $("#ventilator").text(fmt(todaysData["Number of patients in ICU on a ventilator with COVID-19"]));
                    $("#ltcCases").text(fmt(todaysData["Total Positive LTC Resident Cases"]));
                    $("#ltcHcwCases").text(fmt(todaysData["Total Positive LTC HCW Cases"]));
                    $("#ltcDeaths").text(fmt(todaysData["Total LTC Resident Deaths"]));
                    $("#ltcHcwDeaths").text(fmt(todaysData["Total LTC HCW Deaths"]));
                    $(".delta").each(function () {
                        $(this).addClass(function () { let x = Number(this.innerText.replace(",", "")) > 0 ? "positive" : "negative"; return x });
                        if ($(this).hasClass("positive")) { $(this).prepend("+") }
                    });


                }
            });

            // Vaccine data
            $.ajax({
                type: 'POST',
                url: 'https://data.ontario.ca/en/api/3/action/datastore_search',
                cache: true,
                data: {
                    resource_id: '8a89caa9-511c-4568-af89-7f2174b4378c', // Vaccines
                    limit: 32000
                },
                dataType: "jsonp",
                success: function (data) {

                    let length = data.result.records.length;
                    let todaysData = data.result.records[length - 1];
                    let yesterdaysData = data.result.records[length - 2];

                    let terms = ["previous_day_doses_administered", "total_doses_administered", "total_individuals_fully_vaccinated"];
                    terms.forEach((term) => {
                        todaysData[term] = todaysData[term].replace(",", "");
                        yesterdaysData[term] = yesterdaysData[term].replace(",", "");
                    });

                    $("#daily-doses").text(fmt(todaysData["previous_day_doses_administered"]));
                    $("#total-doses").text(fmt(todaysData["total_doses_administered"]));
                    $("#total-vaccinated").text(fmt(todaysData["total_individuals_fully_vaccinated"]));
                    let partial_total = (Number(todaysData["total_doses_administered"]) - Number(todaysData["total_individuals_fully_vaccinated"]));
                    $("#partially-vaccinated").text(partial_total.toLocaleString());
                    let daily_final = (Number(todaysData["total_individuals_fully_vaccinated"]) - Number(yesterdaysData["total_individuals_fully_vaccinated"]));
                    $("#daily-final").text(daily_final.toLocaleString());
                    let daily_partial = (Number(todaysData["previous_day_doses_administered"]) - Number(daily_final));
                    $("#daily-partial").text(daily_partial.toLocaleString());

                }
            });

        });

        $("main").fadeIn();</script>
</body>

</html>